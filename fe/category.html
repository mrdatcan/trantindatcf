<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Danh m·ª•c s·∫£n ph·∫©m</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="components/product.css">
  <link rel="stylesheet" href="components/category.css">
  <link rel="stylesheet" href="components/header.css">
</head>
<body>
  <!-- Header -->
  <div id="header-placeholder"></div>

  <!-- T√¨m ki·∫øm v√† b·ªô l·ªçc -->
  <section class="filter-bar">
    <input type="text" id="category-search" placeholder="T√¨m s·∫£n ph·∫©m...">
    <select id="filter-price">
      <option value="all">T·∫•t c·∫£</option>
      <option value="low">D∆∞·ªõi 30.000ƒë</option>
      <option value="mid">30.000ƒë ‚Äì 50.000ƒë</option>
      <option value="high">Tr√™n 50.000ƒë</option>
    </select>
    <select id="sort-product">
      <option value="default">M·∫∑c ƒë·ªãnh</option>
      <option value="asc">Gi√° tƒÉng d·∫ßn</option>
      <option value="desc">Gi√° gi·∫£m d·∫ßn</option>
    </select>
  </section>

  <!-- DANH M·ª§C -->
  <section class="top-category">
    <h2 class="section-title">Danh m·ª•c s·∫£n ph·∫©m</h2>
    <div class="category-cards">
      <div class="category-card" onclick="scrollToSection('coffee')">
        <img src="img/news1.jpg" alt="C√† ph√™">
        <p>C√† ph√™</p>
      </div>
      <div class="category-card" onclick="scrollToSection('tea')">
        <img src="img/news2.jpg" alt="Tr√†">
        <p>Tr√†</p>
      </div>
      <div class="category-card" onclick="scrollToSection('cake')">
        <img src="img/news3.jpg" alt="B√°nh ng·ªçt">
        <p>B√°nh ng·ªçt</p>
      </div>
    </div>
  </section>

  <!-- DANH S√ÅCH S·∫¢N PH·∫®M THEO DANH M·ª§C -->
  <section id="coffee" class="product-section">
    <h3 class="category-title">C√† ph√™</h3>
    <div class="product-list"></div>
  </section>

  <section id="tea" class="product-section">
    <h3 class="category-title">Tr√†</h3>
    <div class="product-list"></div>
  </section>

  <section id="cake" class="product-section">
    <h3 class="category-title">B√°nh ng·ªçt</h3>
    <div class="product-list"></div>
  </section>

  <!-- Product Popup -->
  <div id="product-popup" class="popup hidden">
    <div class="popup-content">
      <span class="close-btn" onclick="closePopup()">&times;</span>
      <img id="popup-image" src="" alt="Product Image">
      <h3 id="popup-name"></h3>
      <p id="popup-desc"></p>
      <p id="popup-price"></p>
    </div>
  </div>

  <button id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})">‚¨ÜÔ∏è</button>

  <script>
const API_URL = "https://trantindatcf.onrender.com/api/products";
    let allProducts = [];

    function scrollToSection(id) {
      document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
    }

    function cleanString(str) {
      return (str || "").trim().replace(/[^a-zA-Z0-9-_]/g, "");
    }

    fetch("components/header.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("header-placeholder").innerHTML = data;
       const script = document.createElement("script");
script.src = "components/header.js";
script.onload = () => {
  if (typeof renderUserSection === 'function') renderUserSection();
  updateCartCount(); // üü¢ c·∫≠p nh·∫≠t cart count sau khi header render
};
document.body.appendChild(script);

      });

    fetch(API_URL)
      .then(res => res.json())
      .then(products => {
        allProducts = products;
        renderProducts(products);
      })
      .catch(err => console.error("L·ªói khi load s·∫£n ph·∫©m:", err));

    function renderProducts(products) {
      const map = {
        coffee: document.querySelector("#coffee .product-list"),
        tea: document.querySelector("#tea .product-list"),
        cake: document.querySelector("#cake .product-list")
      };
      Object.values(map).forEach(el => el.innerHTML = "");

      products.forEach(p => {
        const tags = p.tags || [];
        tags.forEach(tag => {
          if (map[tag]) {
            const div = document.createElement("div");
            div.className = "product-item";
            div.innerHTML = `
              <img src="${p.image}" alt="${p.name}" />
              <h3>${p.name}</h3>
              <p>${Number(p.price).toLocaleString()}ƒë</p>
              <button class="add-to-cart"
                data-id="${p.id}"
                data-name="${p.name}"
                data-price="${p.price}"
                data-image="${p.image}">Mua ngay</button>
              <button onclick='showPopup(${JSON.stringify(p)})'>Chi ti·∫øt</button>
            `;
            map[tag].appendChild(div);
          }
        });
      });
    }

    document.getElementById("category-search").addEventListener("input", filterAndRender);
    document.getElementById("filter-price").addEventListener("change", filterAndRender);
    document.getElementById("sort-product").addEventListener("change", filterAndRender);

    function filterAndRender() {
      const keyword = document.getElementById("category-search").value.toLowerCase();
      const priceFilter = document.getElementById("filter-price").value;
      const sortOrder = document.getElementById("sort-product").value;

      let filtered = allProducts.filter(p => p.name.toLowerCase().includes(keyword));

      if (priceFilter !== "all") {
        filtered = filtered.filter(p => {
          if (priceFilter === "low") return p.price < 30000;
          if (priceFilter === "mid") return p.price >= 30000 && p.price <= 50000;
          if (priceFilter === "high") return p.price > 50000;
        });
      }

      if (sortOrder === "asc") filtered.sort((a, b) => a.price - b.price);
      if (sortOrder === "desc") filtered.sort((a, b) => b.price - a.price);

      renderProducts(filtered);
    }

    function showPopup(product) {
      document.getElementById("popup-image").src = product.image;
      document.getElementById("popup-name").textContent = product.name;
      document.getElementById("popup-desc").textContent = "S·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng cao.";
      document.getElementById("popup-price").textContent = product.price.toLocaleString() + "ƒë";
      document.getElementById("product-popup").classList.remove("hidden");
    }

    function closePopup() {
      document.getElementById("product-popup").classList.add("hidden");
    }

    function addToCart(product) {
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      const cleanedId = cleanString(product.id);
      const existingItem = cart.find(item => cleanString(item.id) === cleanedId);

      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({
          id: cleanedId,
          name: product.name.trim().replace(/,+$/, ""),
          price: Number(product.price),
          image: product.image.trim().replace(/,+$/, ""),
          quantity: 1
        });
      }

      localStorage.setItem("cart", JSON.stringify(cart));
      updateCartCount?.();
      alert("ƒê√£ th√™m v√†o gi·ªè h√†ng!");
    }

    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      const total = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
      const el = document.querySelector(".cart-count");
      if (el) el.textContent = total;
    }

    document.addEventListener("click", e => {
      if (e.target.classList.contains("add-to-cart")) {
        const btn = e.target;
        const product = {
          id: btn.dataset.id,
          name: btn.dataset.name,
          price: Number(btn.dataset.price),
          image: btn.dataset.image
        };
        addToCart(product);
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      updateCartCount();
    });

    document.addEventListener("keydown", e => {
      if (e.key === "Escape") closePopup();
    });
  </script>
  <script src="components/cart.js"></script>

</body>
</html>